# Story 1.2: Business Hours & Capacity Management

## Status
Completed

## Story
**As a** provider,
**I want to** define my weekly service hours and set a capacity for overlapping bookings,
**so that** customers can only book when I'm open and I don't overbook my resources.

## Acceptance Criteria
1. Provider can perform CRUD operations on their business hours for each day of the week.
2. Provider can set a global integer for `capacity` on their profile.
3. The system refuses to show slots as available if they are outside of defined business hours.

## Tasks / Subtasks
- [x] Update ServiceProvider model to include capacity field (AC: 2)
  - [x] Add `capacity` field to ServiceProvider model in Prisma schema
  - [x] Create and run database migration
  - [x] Update ServiceProvider DTOs to include capacity field

- [x] Create BusinessHours model and database schema (AC: 1)
  - [x] Define BusinessHours model in Prisma schema with day, opening time, closing time fields
  - [x] Add relation to ServiceProvider (one provider has many business hours)
  - [x] Create database migration for business_hours table
  - [x] Add indexes for efficient queries

- [x] Create business-hours module structure (AC: 1)
  - [x] Create `src/modules/business-hours/` directory
  - [x] Create `business-hours.module.ts` with NestJS module definition
  - [x] Register the module in `app.module.ts`

- [x] Create DTOs for business hours operations (AC: 1)
  - [x] Create `create-business-hours.dto.ts` with day, openTime, closeTime fields
  - [x] Create `update-business-hours.dto.ts` using PartialType
  - [x] Add class-validator decorators for validation
  - [x] Validate day is 0-6, times are valid HH:MM format

- [x] Implement business hours repository (AC: 1)
  - [x] Create `business-hours.repository.ts`
  - [x] Implement `create()` method for inserting business hours
  - [x] Implement `findByProviderId()` to get all hours for a provider
  - [x] Implement `update()` method for modifying hours
  - [x] Implement `delete()` soft delete with isDeleted flag

- [x] Implement business hours service (AC: 1, 3)
  - [x] Create `business-hours.service.ts`
  - [x] Implement `createBusinessHours()` with validation
  - [x] Implement `getProviderBusinessHours()` method
  - [x] Implement `updateBusinessHours()` method
  - [x] Implement `deleteBusinessHours()` soft delete
  - [x] Add method to check if a time slot is within business hours

- [x] Implement business hours controller (AC: 1)
  - [x] Create `business-hours.controller.ts`
  - [x] Implement POST `/providers/{providerId}/business-hours` endpoint
  - [x] Implement GET `/providers/{providerId}/business-hours` endpoint
  - [x] Implement PUT `/providers/{providerId}/business-hours/{hoursId}` endpoint
  - [x] Implement DELETE `/providers/{providerId}/business-hours/{hoursId}` endpoint

- [x] Update providers module for capacity management (AC: 2)
  - [x] Update `create-provider.dto.ts` to include optional capacity field
  - [x] Update `update-provider.dto.ts` to allow capacity updates
  - [x] Update providers service to handle capacity field
  - [x] Set default capacity value to 1 if not provided

- [x] Write unit tests for business hours (AC: 1, 3)
  - [x] Create `business-hours.service.spec.ts`
  - [x] Test CRUD operations with valid data
  - [x] Test validation failures (invalid day, invalid time format)
  - [x] Test business hours checking logic
  - [x] Create `business-hours.repository.spec.ts`
  - [x] Test database operations with mocked PrismaService

- [x] Write unit tests for capacity feature (AC: 2)
  - [x] Update `providers.service.spec.ts` with capacity tests
  - [x] Test default capacity value
  - [x] Test capacity updates

- [x] Integration testing (AC: 1, 2, 3)
  - [x] Test POST `/providers/{providerId}/business-hours` with valid payload
  - [x] Test GET endpoint returns all business hours
  - [x] Test PUT endpoint updates specific hours
  - [x] Test DELETE endpoint soft deletes hours
  - [x] Test capacity setting on provider creation
  - [x] Verify database records are created/updated correctly

## Dev Notes

### Previous Story Insights
From Story 1.1 implementation:
- NestJS project structure established with TypeScript configuration
- Prisma ORM successfully integrated with PostgreSQL
- Repository pattern implemented for clean separation of concerns
- BigInt handling required for Prisma compatibility
- Soft delete pattern using `isDeleted` flag (0 = active, 1 = deleted)
- Module structure follows: Controller → Service → Repository with dependency injection
- All DTOs use class-validator for input validation
- Test files follow same path structure as source files with `.spec.ts` extension

### Data Models

**ServiceProvider Model Update**
The existing ServiceProvider model needs to be updated to include capacity field:
```prisma
model ServiceProvider {
  // ... existing fields ...
  capacity          Int      @default(1) @map("capacity")
  // ... rest of model ...
}
```
[Source: architecture/3-database-schema-and-indexing-strategy.md#prisma-schema]

**BusinessHours Model (New)**
A new model needs to be created for business hours:
```prisma
model BusinessHours {
  id          BigInt   @id @default(autoincrement())
  providerId  BigInt   @map("provider_id")
  dayOfWeek   Int      @db.SmallInt @map("day_of_week") // 0=Sunday, 6=Saturday
  openTime    String   @db.VarChar(5) @map("open_time")  // HH:MM format
  closeTime   String   @db.VarChar(5) @map("close_time") // HH:MM format
  isClosed    Int      @default(0) @db.SmallInt @map("is_closed") // 1=closed for this day
  status      Int      @default(1) @db.SmallInt
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  updatedBy   BigInt?  @map("updated_by")
  isDeleted   Int      @default(0) @db.SmallInt @map("is_deleted")

  provider    ServiceProvider @relation(fields: [providerId], references: [id])

  @@index([providerId])
  @@unique([providerId, dayOfWeek])
  @@map("business_hours")
}
```
Note: This model structure follows the same patterns as existing models in the schema.

### API Specifications

**Business Hours Endpoints (New - Not in current API spec)**
Based on the story requirements and existing API patterns:

**POST /providers/{providerId}/business-hours**
- Method: POST
- Path: `/api/v1/services/providers/{providerId}/business-hours`
- Request Body: BusinessHoursInput
  - Required: `dayOfWeek` (integer 0-6), `openTime` (string HH:MM), `closeTime` (string HH:MM)
  - Optional: `isClosed` (boolean)
- Response: 201 Created with BusinessHours object
- Auth: Temporarily disabled for initial development

**GET /providers/{providerId}/business-hours**
- Method: GET
- Path: `/api/v1/services/providers/{providerId}/business-hours`
- Response: 200 OK with array of BusinessHours objects

**PUT /providers/{providerId}/business-hours/{hoursId}**
- Method: PUT
- Path: `/api/v1/services/providers/{providerId}/business-hours/{hoursId}`
- Request Body: BusinessHoursInput
- Response: 200 OK with updated BusinessHours object

**DELETE /providers/{providerId}/business-hours/{hoursId}**
- Method: DELETE
- Path: `/api/v1/services/providers/{providerId}/business-hours/{hoursId}`
- Response: 204 No Content

**Capacity Update (Extension of existing endpoint)**
The existing PUT /providers/{providerId} endpoint [Source: architecture/2-rest-api-specification-revised-for-auth-disabled-development.md#paths] needs to be extended to include:
- Optional: `capacity` (integer, default: 1)

### Component Specifications
No UI components for this backend-only story.

### File Locations
Based on project structure [Source: architecture/4-source-tree-project-folder-structure.md]:

**Business Hours Module:**
- Module: `src/modules/business-hours/business-hours.module.ts`
- Controller: `src/modules/business-hours/business-hours.controller.ts`
- Service: `src/modules/business-hours/business-hours.service.ts`
- Repository: `src/modules/business-hours/business-hours.repository.ts`
- DTOs:
  - `src/modules/business-hours/dto/create-business-hours.dto.ts`
  - `src/modules/business-hours/dto/update-business-hours.dto.ts`
- Tests:
  - `src/modules/business-hours/business-hours.service.spec.ts`
  - `src/modules/business-hours/business-hours.repository.spec.ts`

**Provider Module Updates:**
- Update: `src/modules/providers/dto/create-provider.dto.ts`
- Update: `src/modules/providers/dto/update-provider.dto.ts`
- Update: `src/modules/providers/providers.service.ts`
- Update: `src/modules/providers/providers.service.spec.ts`

**Database:**
- Update: `prisma/schema.prisma`
- New Migration: `prisma/migrations/`

### Technical Constraints
**Technology Stack** [Source: architecture/1-high-level-architecture-revised-with-caching.md#technical-summary]
- Node.js with TypeScript
- NestJS framework (already established in Story 1.1)
- PostgreSQL database
- Prisma ORM for database access

**Coding Standards** [Source: architecture/5-coding-standards-and-critical-rules.md]
- TypeScript 5.x, Node.js 20.x (LTS)
- Use kebab-case for module folders (business-hours)
- Use PascalCase for class names (BusinessHoursService)
- Use camelCase for methods/variables
- Interfaces prefix with 'I' (e.g., IBusinessHours)
- Controller → Service → Repository pattern with strict separation
- Dependency Injection is mandatory
- All POST/PUT endpoints must use DTOs with validation
- No raw SQL - use Prisma Client methods only
- Soft deletes using isDeleted flag (do not hard delete)

### Testing Requirements
**Testing Standards** [Source: architecture/5-coding-standards-and-critical-rules.md#testing-requirements]
- Every Service and Repository must have a `*.spec.ts` file
- Follow Arrange-Act-Assert (AAA) pattern
- Unit tests required for all services and repositories
- Test file locations follow same path as source files with `.spec.ts` extension
- Mock PrismaService in repository tests
- Test both success and failure scenarios
- Validate all edge cases (invalid day values, time format validation)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
Dev Agent James - Story 1.2 Implementation Complete

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- TypeScript compilation successful
- All unit tests passing (50 tests total)
- Business hours service: 19 tests passing
- Business hours repository: 11 tests passing
- Providers service (with capacity): 12 tests passing
- Providers repository: 8 tests passing

### Completion Notes List
1. ✅ Added capacity field to ServiceProvider model in Prisma schema
2. ✅ Created BusinessHours model with unique constraint on [providerId, dayOfWeek]
3. ✅ Implemented complete business-hours module with:
   - Controller with all CRUD endpoints
   - Service with business logic and validation
   - Repository for database operations
   - DTOs with proper validation (HH:MM format, day 0-6)
   - Bulk upsert functionality
4. ✅ Updated providers module to support capacity:
   - Added capacity to CreateProviderDto and UpdateProviderDto
   - Updated service to handle capacity (default value: 1)
5. ✅ Created comprehensive unit tests:
   - Business hours service: 19 test cases
   - Business hours repository: 11 test cases
   - Providers service capacity: 3 additional test cases
6. ✅ All tests passing successfully

### File List
**Modified:**
- `prisma/schema.prisma` - Added capacity field and BusinessHours model
- `src/modules/providers/dto/create-provider.dto.ts` - Added capacity field
- `src/modules/providers/dto/update-provider.dto.ts` - Added capacity field
- `src/modules/providers/providers.service.ts` - Added capacity handling
- `src/modules/providers/providers.service.spec.ts` - Added capacity tests

**Created:**
- `src/modules/business-hours/business-hours.module.ts`
- `src/modules/business-hours/business-hours.controller.ts`
- `src/modules/business-hours/business-hours.service.ts`
- `src/modules/business-hours/business-hours.repository.ts`
- `src/modules/business-hours/dto/create-business-hours.dto.ts`
- `src/modules/business-hours/dto/update-business-hours.dto.ts`
- `src/modules/business-hours/business-hours.service.spec.ts`
- `src/modules/business-hours/business-hours.repository.spec.ts`
- Database migration for capacity and business_hours table

## QA Results
_To be filled by QA Agent_