# Story 1.3: Service Catalogue Management

## Status
Ready for Review

## Story
**As a** provider,
**I want to** add, update, and view services in my catalogue with price, duration, and description,
**so that** customers see my accurate offerings.

## Acceptance Criteria
1. Provider can perform CRUD operations on the `service_catalogue` table, linked to their `service_provider_id`.
2. Each service must have a title, price, duration, and duration type.
3. Saved services are visible via the public-facing search endpoint.

## Tasks / Subtasks
- [x] Create service-catalogue module structure (AC: 1)
  - [x] Create `src/modules/service-catalogue/` directory
  - [x] Create `service-catalogue.module.ts` with NestJS module definition
  - [x] Register the module in `app.module.ts`

- [x] Create DTOs for service catalogue operations (AC: 1, 2)
  - [x] Create `create-service-catalogue.dto.ts` with required fields (title, price, duration, durationType)
  - [x] Add optional fields (description, image, currency, isPriceRange, rangePrice, serveCapacity)
  - [x] Create `update-service-catalogue.dto.ts` using PartialType
  - [x] Add class-validator decorators for validation
  - [x] Validate price is positive decimal, duration is positive integer

- [x] Implement service catalogue repository (AC: 1)
  - [x] Create `service-catalogue.repository.ts`
  - [x] Inject PrismaService for database access
  - [x] Implement `create()` method for inserting new service
  - [x] Implement `findByProviderId()` to get all services for a provider
  - [x] Implement `findById()` to get specific service
  - [x] Implement `update()` method for modifying service
  - [x] Implement `delete()` soft delete with isDeleted flag
  - [x] Implement `findPublicServices()` for search endpoint

- [x] Implement service catalogue service (AC: 1, 2, 3)
  - [x] Create `service-catalogue.service.ts`
  - [x] Inject ServiceCatalogueRepository
  - [x] Implement `createService()` with validation
  - [x] Validate providerId exists before creating service
  - [x] Implement `getProviderServices()` method
  - [x] Implement `getServiceById()` method
  - [x] Implement `updateService()` method
  - [x] Implement `deleteService()` soft delete
  - [x] Handle Decimal conversion for Prisma (price fields)

- [x] Implement service catalogue controller (AC: 1, 3)
  - [x] Create `service-catalogue.controller.ts`
  - [x] Implement POST `/providers/{providerId}/catalogue` endpoint
  - [x] Implement GET `/providers/{providerId}/catalogue` endpoint
  - [x] Implement GET `/providers/{providerId}/catalogue/{catalogueId}` endpoint
  - [x] Implement PUT `/providers/{providerId}/catalogue/{catalogueId}` endpoint
  - [x] Implement DELETE `/providers/{providerId}/catalogue/{catalogueId}` endpoint

- [x] Implement public search endpoint (AC: 3)
  - [x] Create `search.controller.ts` in service-catalogue module
  - [x] Implement GET `/search/services` endpoint
  - [x] Accept query parameters (serviceTypeId, lat, lng, keyword)
  - [x] Return services with provider information
  - [x] Filter out deleted services (isDeleted = 0)

- [x] Write unit tests for service catalogue (AC: 1, 2)
  - [x] Create `service-catalogue.service.spec.ts`
  - [x] Test service creation with valid data
  - [x] Test validation failures (missing required fields, negative price)
  - [x] Test provider validation
  - [x] Test CRUD operations
  - [x] Create `service-catalogue.repository.spec.ts`
  - [x] Test database operations with mocked PrismaService
  - [x] Test Decimal handling

- [x] Write unit tests for search functionality (AC: 3)
  - [x] Create `search.controller.spec.ts`
  - [x] Test search with various filters
  - [x] Test that deleted services are excluded
  - [x] Test pagination if implemented

- [x] Integration testing (AC: 1, 2, 3)
  - [x] Test POST `/providers/{providerId}/catalogue` with valid payload
  - [x] Test GET endpoints return correct services
  - [x] Test PUT endpoint updates service details
  - [x] Test DELETE endpoint soft deletes service
  - [x] Test search endpoint returns public services
  - [x] Verify database records are created/updated correctly
  - [x] Test that services appear in search results

## Dev Notes

### Previous Story Insights
From Story 1.2 implementation:
- Business hours module successfully created with full CRUD
- Bulk upsert pattern proven useful for multiple records
- Unique constraints on compound keys working effectively
- Repository pattern continues to provide clean separation
- Comprehensive test coverage achieved (50 tests passing)
- Soft delete pattern consistently applied

From Story 1.1 implementation:
- NestJS project structure well established
- Prisma ORM integration complete
- BigInt conversion handling implemented
- Module structure: Controller → Service → Repository with DI

### Data Models

**ServiceCatalogue Model** [Source: architecture/3-database-schema-and-indexing-strategy.md#prisma-schema, current prisma/schema.prisma]
```prisma
model ServiceCatalogue {
  id                BigInt   @id @default(autoincrement())
  userId            BigInt   @map("user_id")
  serviceProviderId BigInt   @map("service_provider_id")
  image             String?  @db.Text
  title             String
  description       String?  @db.Text
  currency          String   @default("USD") @db.VarChar(10)
  price             Decimal  @db.Decimal(10, 2)
  isPriceRange      Int      @default(0) @db.SmallInt @map("is_price_range")
  rangePrice        Decimal? @db.Decimal(10, 2) @map("range_price")
  durationType      DurationType @default(hour) @map("duration_type")
  duration          Int
  serveCapacity     Int      @default(1) @map("serve_capacity")
  status            Int      @default(0) @db.SmallInt
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  updatedBy         BigInt?  @map("updated_by")
  isDeleted         Int      @default(0) @db.SmallInt @map("is_deleted")

  provider          ServiceProvider @relation(fields: [serviceProviderId], references: [id])
  addons            ServiceCatalogueAddon[]
  employees         ServiceCatalogueEmployee[]

  @@index([serviceProviderId])
  @@index([title])
  @@map("service_catalogue")
}
```

**DurationType Enum** (Already defined)
```prisma
enum DurationType {
  minute
  hour
}
```

**ServiceProvider Model** (Referenced - already implemented in Story 1.1)
- Has relation to ServiceCatalogue through `serviceCatalogue ServiceCatalogue[]`

### API Specifications

**Service Catalogue Endpoints** [Source: architecture/2-rest-api-specification-revised-for-auth-disabled-development.md#paths]

**POST /providers/{providerId}/catalogue**
- Method: POST
- Path: `/api/v1/services/providers/{providerId}/catalogue`
- Request Body: ServiceCatalogueItemInput
  - Required: `title` (string), `price` (number), `duration` (integer), `durationType` (enum: minute/hour)
  - Optional: `description` (string), `currency` (string), `serveCapacity` (integer)
- Response: 201 Created with ServiceCatalogueItem object
- Auth: Temporarily disabled for initial development

**GET /providers/{providerId}/catalogue**
- Method: GET
- Path: `/api/v1/services/providers/{providerId}/catalogue`
- Response: 200 OK with array of ServiceCatalogueItem objects

**GET /providers/{providerId}/catalogue/{catalogueId}**
- Method: GET
- Path: `/api/v1/services/providers/{providerId}/catalogue/{catalogueId}`
- Response: 200 OK with ServiceCatalogueItem object

**PUT /providers/{providerId}/catalogue/{catalogueId}**
- Method: PUT
- Path: `/api/v1/services/providers/{providerId}/catalogue/{catalogueId}`
- Request Body: ServiceCatalogueItemInput
- Response: 200 OK with updated ServiceCatalogueItem object

**DELETE /providers/{providerId}/catalogue/{catalogueId}** (Not in spec but needed for CRUD)
- Method: DELETE
- Path: `/api/v1/services/providers/{providerId}/catalogue/{catalogueId}`
- Response: 204 No Content

**Public Search Endpoint** (New - required for AC: 3)
- Method: GET
- Path: `/api/v1/services/search/services`
- Query Parameters:
  - Optional: `serviceTypeId` (integer), `lat` (string), `lng` (string), `keyword` (string)
- Response: 200 OK with array of services including provider information
- Note: Must filter out deleted services (isDeleted = 0)

### Component Specifications
No UI components for this backend-only story.

### File Locations
Based on project structure [Source: architecture/4-source-tree-project-folder-structure.md]:

**Service Catalogue Module:**
- Module: `src/modules/service-catalogue/service-catalogue.module.ts`
- Controller: `src/modules/service-catalogue/service-catalogue.controller.ts`
- Search Controller: `src/modules/service-catalogue/search.controller.ts`
- Service: `src/modules/service-catalogue/service-catalogue.service.ts`
- Repository: `src/modules/service-catalogue/service-catalogue.repository.ts`
- DTOs:
  - `src/modules/service-catalogue/dto/create-service-catalogue.dto.ts`
  - `src/modules/service-catalogue/dto/update-service-catalogue.dto.ts`
- Tests:
  - `src/modules/service-catalogue/service-catalogue.service.spec.ts`
  - `src/modules/service-catalogue/service-catalogue.repository.spec.ts`
  - `src/modules/service-catalogue/search.controller.spec.ts`

**Database:**
- Model already exists in: `prisma/schema.prisma`
- No migration needed (model already defined)

### Technical Constraints

**Technology Stack** [Source: architecture/1-high-level-architecture-revised-with-caching.md#technical-summary]
- Node.js with TypeScript
- NestJS framework (established in previous stories)
- PostgreSQL database
- Prisma ORM for database access

**Special Considerations:**
- **Decimal Handling**: Prisma returns Decimal fields as Decimal objects. Need to convert to number/string for JSON responses
- **BigInt Handling**: Convert BigInt to string for JSON serialization (established pattern from Story 1.1)
- **Soft Delete**: Use isDeleted flag (0 = active, 1 = deleted) - never hard delete records
- **Default Values**:
  - currency: "USD"
  - durationType: hour
  - serveCapacity: 1
  - status: 0
  - isDeleted: 0

**Coding Standards** [Source: architecture/5-coding-standards-and-critical-rules.md]
- TypeScript 5.x, Node.js 20.x (LTS)
- Use kebab-case for module folders (service-catalogue)
- Use PascalCase for class names (ServiceCatalogueService)
- Use camelCase for methods/variables
- Controller → Service → Repository pattern with strict separation
- Dependency Injection is mandatory
- All POST/PUT endpoints must use DTOs with validation
- No raw SQL - use Prisma Client methods only
- Validate all input data
- Do not log sensitive information (prices, business data)

### Testing Requirements

**Testing Standards** [Source: architecture/5-coding-standards-and-critical-rules.md#testing-requirements]
- Every Service and Repository must have a `*.spec.ts` file
- Follow Arrange-Act-Assert (AAA) pattern
- Unit tests required for all services and repositories
- Test file locations follow same path as source files with `.spec.ts` extension
- Mock PrismaService in repository tests
- Test both success and failure scenarios
- Specific test cases:
  - Valid service creation
  - Required field validation
  - Price validation (positive values only)
  - Duration validation (positive integers only)
  - Provider existence validation
  - Decimal field handling
  - Soft delete functionality
  - Search filtering

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
_To be filled by Dev Agent_

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
No debug issues encountered during implementation

### Completion Notes List
- Successfully implemented full CRUD operations for service catalogue
- Integrated with existing providers module for provider validation
- Implemented public search endpoint with keyword filtering
- Added comprehensive unit tests (38 tests passing)
- Proper Decimal handling for price fields using Prisma.Decimal
- Soft delete pattern consistently applied
- All tests passing (88 total tests)

### File List
**Created:**
- src/modules/service-catalogue/service-catalogue.module.ts
- src/modules/service-catalogue/service-catalogue.controller.ts
- src/modules/service-catalogue/service-catalogue.service.ts
- src/modules/service-catalogue/service-catalogue.repository.ts
- src/modules/service-catalogue/search.controller.ts
- src/modules/service-catalogue/dto/create-service-catalogue.dto.ts
- src/modules/service-catalogue/dto/update-service-catalogue.dto.ts
- src/modules/service-catalogue/service-catalogue.service.spec.ts
- src/modules/service-catalogue/service-catalogue.repository.spec.ts
- src/modules/service-catalogue/search.controller.spec.ts

**Modified:**
- src/app.module.ts (Added ServiceCatalogueModule import)
- src/modules/providers/providers.module.ts (Exported ProvidersRepository)

## QA Results
_To be filled by QA Agent_