# Story 1.4: Basic Service Search

## Status
Done

## Story
**As a** customer,
**I want to** search for providers by service type and location,
**so that** I can see relevant options near me.

## Acceptance Criteria
1. An API endpoint exists that accepts `service_type_id` and a location (lat/lng) as parameters.
2. The endpoint returns a list of service providers that match the criteria.
3. The search results include basic provider and service catalogue information.

## Tasks / Subtasks
- [x] Enhance search controller with improved validation (AC: 1)
  - [x] Add DTO for search query parameters with proper validation
  - [x] Validate lat/lng are valid coordinates (range checks)
  - [x] Validate serviceTypeId is a positive integer if provided
  - [x] Add proper OpenAPI documentation annotations

- [x] Enhance search service method for provider filtering (AC: 1, 2)
  - [x] Modify `searchPublicServices` to properly filter by serviceTypeId
  - [x] Ensure serviceTypeId filtering works at provider level
  - [x] Maintain backward compatibility with existing keyword search

- [x] Implement location-based search in repository (AC: 1, 2)
  - [x] Add distance calculation logic for lat/lng filtering
  - [x] Use provider's geoRadius field to determine search radius
  - [x] Filter providers within specified radius from search coordinates
  - [x] Order results by distance (closest first)

- [x] Enhance response structure to include provider details (AC: 3)
  - [x] Ensure provider information is included in search results
  - [x] Include provider's business name, location, and service type
  - [x] Include complete service catalogue information for each provider
  - [x] Transform BigInt and Decimal fields properly for JSON response

- [x] Add comprehensive unit tests (AC: 1, 2, 3)
  - [x] Test search with serviceTypeId filter only
  - [x] Test search with location filters only
  - [x] Test search combining serviceTypeId and location
  - [x] Test search with invalid parameters
  - [x] Test distance calculation and ordering
  - [x] Test response structure includes all required fields

- [x] Add integration tests for search endpoint (AC: 1, 2, 3)
  - [x] Test full search flow with various parameter combinations
  - [x] Verify proper filtering and data inclusion
  - [x] Test error handling for invalid inputs

## Dev Notes

### Previous Story Insights
From Story 1.3, a basic search endpoint was already created at `/api/v1/services/search/services` with keyword filtering capability. The SearchController and basic searchPublicServices method exist in the service-catalogue module. The current implementation needs enhancement to support serviceTypeId and location-based filtering as per the story requirements.

### Project Structure
**Existing Search Implementation** [Source: Story 1.3 implementation]
- Search Controller: `src/modules/service-catalogue/search.controller.ts`
- Service Method: `src/modules/service-catalogue/service-catalogue.service.ts::searchPublicServices`
- Repository Method: `src/modules/service-catalogue/service-catalogue.repository.ts::findPublicServices`

**Files to Modify:**
- `src/modules/service-catalogue/search.controller.ts` - Enhance with validation
- `src/modules/service-catalogue/dto/search-services.dto.ts` - Create new DTO
- `src/modules/service-catalogue/service-catalogue.service.ts` - Enhance search logic
- `src/modules/service-catalogue/service-catalogue.repository.ts` - Add location filtering

**Test Files to Update:**
- `src/modules/service-catalogue/search.controller.spec.ts`
- `src/modules/service-catalogue/service-catalogue.service.spec.ts`
- `src/modules/service-catalogue/service-catalogue.repository.spec.ts`

### Database Schema
**ServiceProvider Model** [Source: architecture/3-database-schema-and-indexing-strategy.md]
- `serviceTypeId` (BigInt) - Links to ServiceType
- `lat` (String, VarChar(50)) - Latitude coordinate
- `lng` (String, VarChar(50)) - Longitude coordinate
- `geoRadius` (Int, default: 10) - Search radius in kilometers
- Indexes exist on `[lat, lng]` for efficient location queries
- Index exists on `serviceTypeId` for type filtering

**ServiceCatalogue Model** [Source: architecture/3-database-schema-and-indexing-strategy.md]
- `serviceProviderId` (BigInt) - Links to ServiceProvider
- `title` (String) - Indexed for text search
- `price` (Decimal 10,2) - Needs conversion for JSON
- `duration` (Int) with `durationType` (enum: minute/hour)

### API Specification
**Search Endpoint Requirements** [Source: Epic 1, Story 1.4]
- Path: `/api/v1/services/search/services` (already exists)
- Query Parameters:
  - `service_type_id` (optional): Integer ID of service type
  - `lat` (optional): Latitude as string
  - `lng` (optional): Longitude as string
  - `keyword` (optional): Text search in service titles (existing)
- Response: Array of services with provider information

### Technical Constraints
**Technology Stack** [Source: architecture/5-coding-standards-and-critical-rules.md]
- TypeScript 5.x, Node.js 20.x (LTS)
- NestJS framework with dependency injection
- PostgreSQL with Prisma ORM
- All POST/PUT endpoints must use DTOs with validation

**Decimal/BigInt Handling** [Source: Story 1.3 implementation]
- Convert Prisma Decimal objects to numbers/strings for JSON
- Convert BigInt to string for JSON serialization
- Use established pattern from previous stories

**Coding Standards** [Source: architecture/5-coding-standards-and-critical-rules.md]
- Controller → Service → Repository pattern
- Use kebab-case for module folders
- Use PascalCase for class names
- Use camelCase for methods/variables
- No raw SQL - use Prisma Client methods only
- Validate all input data via DTOs

### Distance Calculation
For location-based search, implement the Haversine formula to calculate distance between two points:
- Convert lat/lng strings to numbers
- Calculate distance in kilometers
- Compare with provider's geoRadius setting
- Order results by calculated distance

### Testing Requirements
**Testing Standards** [Source: architecture/5-coding-standards-and-critical-rules.md]
- Unit tests required for all services and repositories
- Test files use `.spec.ts` extension in same path as source
- Follow Arrange-Act-Assert (AAA) pattern
- Mock PrismaService in repository tests
- Test both success and failure scenarios

**Specific Test Cases:**
- Valid serviceTypeId filtering
- Valid location-based filtering
- Combined serviceTypeId and location filtering
- Invalid coordinate values (out of range)
- Invalid serviceTypeId (negative, non-numeric)
- Empty result sets
- Distance calculation accuracy
- Result ordering by distance
- Provider information inclusion in results
- Service catalogue data completeness

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Scrum Master |
| 2025-09-29 | 1.1 | Story completed and ready for review | Dev Agent James |

## Dev Agent Record
_To be filled by Dev Agent_

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Enhanced search controller with DTO validation and OpenAPI annotations
- Implemented location-based search using Haversine formula for distance calculation
- Added comprehensive provider filtering by serviceTypeId at database level
- Resolved TypeScript compilation errors in test files
- Installed required dependencies: @nestjs/swagger, supertest, @types/supertest

### Completion Notes List
- All acceptance criteria have been met
- Search endpoint now supports serviceTypeId, lat/lng, and keyword filtering
- Location-based search properly filters by provider's geoRadius
- Results are sorted by distance when location parameters are provided
- Provider information including service type is included in response
- All unit and integration tests are passing (55 tests total)
- Build successful with no compilation errors
- Note: businessName field referenced in story does not exist in current schema; used available provider fields instead

### File List
- src/modules/service-catalogue/dto/search-services.dto.ts (Created)
- src/modules/service-catalogue/search.controller.ts (Modified)
- src/modules/service-catalogue/service-catalogue.service.ts (Modified)
- src/modules/service-catalogue/service-catalogue.repository.ts (Modified)
- src/modules/service-catalogue/search.controller.spec.ts (Modified)
- src/modules/service-catalogue/service-catalogue.service.spec.ts (Modified)
- src/modules/service-catalogue/service-catalogue.repository.spec.ts (Modified)
- src/modules/service-catalogue/search.controller.e2e-spec.ts (Created)
- package.json (Modified - dependencies added)

## QA Results
_To be filled by QA Agent_